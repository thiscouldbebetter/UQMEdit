<html>
<body>

<div id="divUi">
	<h3>Ur-Quan Masters Save File Editor</h3>
	<p>
		Upload a save file from the game the Ur-Quan Masters
		to view and edit its contents.  THIS IS A WORK IN PROGRESS.
	</p>

	<div>
		<label>Save File to Upload:</label>
		<input type="file" onchange="inputFile_Changed(this)"></input>
	</div>

	<div>
		<label>Save State as JSON:</label>
		<br />
		<textarea
			id="textareaSaveStateAsJson"
			cols="80" rows="25"
		></textarea>
	</div>

	<button onclick="buttonSave_Clicked()">Save to File</button>


<script type="text/javascript">

// UI events.

function buttonSave_Clicked()
{
	var d = document;
	var textareaSaveStateAsJson =
		d.getElementById("textareaSaveStateAsJson");
	var saveStateAsJson = textareaSaveStateAsJson.value;

	var saveState = SaveState.fromJson(saveStateAsJson);

	var saveStateAsBytes = saveState.toBytes();

	var downloadLink = d.createElement("a");
	throw new Error("todo");
	downloadLink.click();
}

function inputFile_Changed(inputFile)
{
	var file = inputFile.files[0];
	if (file != null)
	{
		var fileReader = new FileReader();
		fileReader.onload = (event) =>
		{
			var contentsAsBinaryString = event.target.result;
			var contentsAsBytes =
				contentsAsBinaryString
					.split("")
					.map(x => x.charCodeAt(0) );

			var saveState = SaveState.fromBytes(contentsAsBytes);

			var saveStateAsJson = saveState.toJson();

			var d = document;
			var textareaSaveStateAsJson =
				d.getElementById("textareaSaveStateAsJson");
			textareaSaveStateAsJson.value = saveStateAsJson;
		}
		fileReader.readAsBinaryString(file);
	}
}

// Classes.

class ByteStream
{
	constructor(bytes)
	{
		this.bytes = bytes;
		this.byteCurrentIndex = 0;
	}

	readByte()
	{
		var byteRead = this.bytes[this.byteCurrentIndex];
		this.byteCurrentIndex++;
		return byteRead;
	}

	readBytes(bytesToRead)
	{
		var bytesRead = [];
		for (var i = 0; i < bytesToRead; i++)
		{
			var byteRead = this.readByte();
			bytesRead.push(byteRead);
		}
		return bytesRead;
	}

	readBytesToEnd()
	{
		var bytesToReadCount =
			this.bytes.length - this.byteCurrentIndex;
		var bytesRead = this.readBytes(bytesToReadCount);
		return bytesRead;
	}

	readInteger16Bit()
	{
		var bytesRead = this.readBytes(2);

		var integerRead =
			(bytesRead[0] << 0)
			| (bytesRead[1] << 8);

		return integerRead;
	}

	readInteger32Bit()
	{
		var bytesRead = this.readBytes(4);

		var integerRead =
			(bytesRead[0] << 0)
			| (bytesRead[1] << 8)
			| (bytesRead[2] << 16)
			| (bytesRead[3] << 24);

		return integerRead;
	}

	readString(charactersToRead)
	{
		var bytesRead = this.readBytes(charactersToRead).filter(x => x > 0);
		var stringRead =
			bytesRead.map(x => String.fromCharCode(x) ).join("");
		stringRead = stringRead.trim();
		return stringRead;
	}

	readStringToEnd()
	{
		var bytesRead = this.readBytesToEnd();
		var stringRead = bytesRead.map(x => String.fromCharCode(x) ).join("");
		return stringRead;
	}


	writeByte(byteToWrite)
	{
		this.bytes[this.byteCurrentIndex] = byteToWrite;
		this.byteCurrentIndex++;
	}

	writeBytes(bytesToWrite)
	{
		bytesToWrite.forEach(x => this.writeByte(x) );
	}

	writeString(stringToWrite, lengthInBytes)
	{
		var stringAsBytes =
			stringToWrite.split("").map(x => x.charCodeAt(0) );
		this.writeBytes(stringAsBytes);
		for (var i = stringAsBytes.length; i < lengthInBytes; i++)
		{
			this.writeByte(0);
		}
	}
}

class Coords
{
	constructor(x, y)
	{
		this.x = x;
		this.y = y;
	}

	static fromByteStream(reader)
	{
		var posX = reader.readInteger32Bit();
		var posY = reader.readInteger32Bit();
		var pos = new Coords(posX, posY);
		return pos;
	}
}

class SaveState
{
	constructor
	(
		header,
		pos,
		resourceUnits,
		fuel,
		flagshipCrew,
		minerals,
		biodataCount,
		modules,
		landerCount,
		flagshipName,
		captainName,
		nearestPlanet,
		difficulty,
		extended,
		nomad,
		customSeed,
		status, 
		landerMods,
		date,
		credits,
		escortShips,
		devices,
		resFactor,
		saveName,
		bytesRemaining
	)
	{
		this.header         = header;
		this.pos            = pos;
		this.resourceUnits  = resourceUnits;
		this.fuel           = fuel;
		this.flagshipCrew   = flagshipCrew;
		this.minerals       = minerals;
		this.biodataCount   = biodataCount;
		this.modules        = modules;
		this.landerCount    = landerCount;
		this.flagshipName   = flagshipName;
		this.captainName    = captainName;
		this.nearestPlanet  = nearestPlanet;
		this.difficulty     = difficulty;
		this.extended       = extended;
		this.nomad          = nomad;
		this.customSeed     = customSeed;
		this.status         = status;
		this.landerMods     = landerMods;
		this.date           = date;
		this.credits        = credits;
		this.escortShips    = escortShips;
		this.devices        = devices;
		this.resFactor      = resFactor;
		this.saveName       = saveName;
		this.bytesRemaining = bytesRemaining;
	}

	// Bytes.

	static fromBytes(saveStateAsBytes)
	{
		var reader = new ByteStream(saveStateAsBytes);

		var header = SaveStateHeader.fromByteStream(reader);

		var pos = Coords.fromByteStream(reader);

		var resourceUnits = reader.readInteger32Bit();
		var fuel = reader.readInteger32Bit();
		var flagshipCrew = reader.readInteger16Bit();
		var mineralsAll = reader.readInteger16Bit();
		var biodataCount = reader.readInteger16Bit();

		var modules = SaveStateModules.fromByteStream(reader);

		var landerCount = reader.readByte();

		var minerals =
			SaveStateMinerals.fromByteStream(reader);

		var flagshipName = reader.readString(16);
		var captainName = reader.readString(16);
		var nearestPlanet = reader.readString(16);

		// How do these work?
		var difficulty = reader.readByte(); // ?
		var extended = reader.readByte(); // ?
		var nomad = reader.readByte(); // ?
		var customSeed = reader.readInteger32Bit(); // ?

		var status = reader.readByte();
		var landerMods = reader.readByte();
		var date = reader.readBytes(4);
		var credits = reader.readInteger16Bit();

		var escortShips0 = reader.readByte(); // 149
		var devices0 = reader.readByte(); // 150
		var escortShips1 = reader.readBytes(12); // 151-162
		var devices1 = reader.readBytes(8); // 163

		var escortShips = new SaveStateEscortShips
		(
			escortShips0, escortShips1
		);

		var devices = new SaveStateDevices
		(
			devices0, devices1
		);

		var resFactor = reader.readByte(); // ? - 179
		var saveName = reader.readString(32);

		var bytesRemaining = reader.readBytesToEnd();

		var saveState = new SaveState
		(
			header,
			pos,
			resourceUnits,
			fuel,
			flagshipCrew,
			minerals,
			biodataCount,
			modules,
			landerCount,
			flagshipName,
			captainName,
			nearestPlanet,
			difficulty,
			extended,
			nomad,
			customSeed,
			status, 
			landerMods,
			date,
			credits,
			escortShips,
			devices,
			resFactor,
			saveName,
			bytesRemaining
		);

		return saveState;
	}

	toBytes()
	{
		var writer = new ByteStream([]);

		writer.writeBytes(this.header.toBytes() );

		writer.writeBytes(this.pos.toBytes() );

		writer.writeInteger32Bits(this.resourceUnits);
		writer.writeInteger32Bit(this.fuel);
		writer.writeInteger16Bit(this.flagshipCrew);
		writer.writeInteger16Bit(this.biodataCount);

		writer.writeBytes(this.modules.toBytes() );

		writer.writeByte(this.landerCount);

		writer.writeBytes(this.minerals.toBytes() );

		writer.writeString(this.flagshipName, 16);
		writer.writeString(this.captainName, 16);
		writer.writeString(this.nearestPlanet, 16);

		// How do these work?
		writer.writeByte(this.difficulty);
		writer.writeByte(this.extended);
		writer.writeByte(this.nomad);
		writer.writeByte(this.customSeed);

		writer.writeByte(this.status);
		writer.writeByte(this.landerMods);
		writer.writeBytes(this.date);
		writer.writeInteger16Bit(this.credits);

		writer.writeByte(this.escortShips.ships0);
		writer.writeByte(this.devices.devices0);
		writer.writeByte(this.escortShips.ships1);
		writer.writeByte(this.devices.devices1);

		writer.writeByte(this.resFactor);
		writer.writeString(this.saveName, 32);

		writer.writeBytes(this.bytesRemaining);

		var saveStateAsBytes = writer.bytes;

		return saveStateAsBytes;
	}

	// JSON.

	static fromJson(saveStateAsJson)
	{
		var saveStateAsObject = JSON.parse(saveStateAsJson);
		var saveState = SaveState.prototypesSetOnObject(saveStateAsObject);
		return saveState;
	}
	
	static prototypesSetOnObject(object)
	{
		Object.setPrototypeOf(object, SaveState.prototype);
		throw new Error("todo");
	}

	toJson()
	{
		var bytesRemaining = this.bytesRemaining;
		var bytesRemainingAsHexadecimal =
			bytesRemaining
				.map(x => x.toString(16).padStart(2, "0") )
				.join(" ");
		this.bytesRemaining = bytesRemainingAsHexadecimal;
		var returnValue = JSON.stringify(this, null, 4);
		this.bytesRemaining = bytesRemaining;
		return returnValue;
	}
}

class SaveStateDevices
{
	constructor(devices0, devices1)
	{
		this.devices0 = devices0;
		this.devices1 = devices1;
	}
}

class SaveStateEscortShips
{
	constructor(ships0, ships1)
	{
		this.ships0 = ships0;
		this.ships1 = ships1;
	}
}

class SaveStateHeader
{
	constructor(magicString, magicNumber)
	{
		this.magicString = magicString;
		this.magicNumber = magicNumber;
	}

	static fromByteStream(reader)
	{
		var magicString = reader.readString(8);
		var magicNumber = reader.readInteger32Bit();
		var header = new SaveStateHeader(magicString, magicNumber);
		return header;
	}
}

class SaveStateMinerals
{
	constructor
	(
		commonElements,
		corrosives,
		baseMetals,
		nobleGases,
		rareEarths,
		preciousMetals,
		radioactives,
		exotics
	)
	{
		this.commonElements = commonElements;
		this.corrosives     = corrosives;
		this.baseMetals     = baseMetals;
		this.nobleGases     = nobleGases;
		this.rareEarths     = rareEarths;
		this.preciousMetals = preciousMetals;
		this.radioactives   = radioactives;
		this.exotics        = exotics;
	}

	static fromByteStream(reader)
	{
		var mineralCountCommonElements = reader.readInteger16Bit();
		var mineralCountCorrosives = reader.readInteger16Bit();
		var mineralCountBaseMetals = reader.readInteger16Bit();
		var mineralCountNobleGases = reader.readInteger16Bit();
		var mineralCountRareEarths = reader.readInteger16Bit();
		var mineralCountPreciousMetals = reader.readInteger16Bit();
		var mineralCountRadioactives = reader.readInteger16Bit();
		var mineralCountExotics = reader.readInteger16Bit();
		var minerals = new SaveStateMinerals
		(
			mineralCountCommonElements,
			mineralCountCorrosives,
			mineralCountBaseMetals,
			mineralCountNobleGases,
			mineralCountRareEarths,
			mineralCountPreciousMetals,
			mineralCountRadioactives,
			mineralCountExotics
		);

		return minerals;
	}
}

class SaveStateModules
{
	constructor(moduleSlots, driveSlots, turningJetSlots)
	{
		this.moduleSlots = moduleSlots;
		this.driveSlots = driveSlots;
		this.turningJetSlots = turningJetSlots;
	}

	static fromByteStream(reader)
	{
		var moduleSlots = reader.readBytes(16);
		var driveSlots = reader.readBytes(11);
		var turningJetSlots = reader.readBytes(8);
		var modules = new SaveStateModules
		(
			moduleSlots,
			driveSlots,
			turningJetSlots
		);

		return modules;
	}
}



</script>


</body>
</html>